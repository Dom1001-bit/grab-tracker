<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grab Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-emerald-400">Grab Expense Tracker</h1>
            <p class="text-gray-400 mt-2">Your consolidated Grab expenses, updated automatically from your email.</p>
        </header>

        <!-- User Info and Controls -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <div class="text-center md:text-left">
                <span class="text-sm text-gray-400 block">User ID</span>
                <span id="userId" class="text-xs text-emerald-500 break-all">Loading...</span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="month-filter" class="text-gray-300">Filter by Month:</label>
                <select id="month-filter" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5">
                    <option value="all">All Months</option>
                </select>
            </div>
            <div class="text-center md:text-right bg-gray-900 p-3 rounded-lg">
                 <span class="text-sm text-gray-400 block">Month Total</span>
                <span id="month-total" class="text-2xl font-bold text-emerald-400">â‚±0.00</span>
            </div>
        </div>

        <!-- Expenses Table -->
        <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-emerald-400 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3">Merchant</th>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3 text-right">Total Bill</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body">
                        <!-- Loading State -->
                        <tr>
                            <td colspan="3" class="text-center p-8" id="loading-state">
                                <div class="flex justify-center items-center space-x-2">
                                    <svg class="animate-spin h-5 w-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-gray-400">Loading expenses...</span>
                                </div>
                            </td>
                        </tr>
                        <!-- No Data State -->
                        <tr id="no-data-state" class="hidden">
                            <td colspan="3" class="text-center p-8 text-gray-500">
                                No expenses found. Make sure your Apps Script has run.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Powered by Google Apps Script & Firebase</p>
        </footer>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db;
        let auth;
        let userId;
        let allExpenses = [];
        
        // --- DOM Elements ---
        const userIdEl = document.getElementById('userId');
        const monthFilterEl = document.getElementById('month-filter');
        const monthTotalEl = document.getElementById('month-total');
        const tableBodyEl = document.getElementById('expenses-table-body');
        const loadingStateEl = document.getElementById('loading-state');
        const noDataStateEl = document.getElementById('no-data-state');

        // --- Firebase Configuration ---
        // This configuration is now hardcoded with the details you provided.
        const firebaseConfig = {
          apiKey: "AIzaSyBa7qHxfqWK4Tnbtr-Z4Wz3j9jWxdxq8ys",
          authDomain: "grab-expense-tracker-167a3.firebaseapp.com",
          projectId: "grab-expense-tracker-167a3",
          storageBucket: "grab-expense-tracker-167a3.firebasestorage.app",
          messagingSenderId: "899502074528",
          appId: "1:899502074528:web:ab59e243fc39ab37bcf7c5"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-grab-tracker';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Main App Logic ---

        /**
         * Initializes the Firebase app and services.
         */
        function initializeFirebase() {
            try {
                // Check if firebaseConfig has valid keys before initializing
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("Firebase configuration is missing or invalid.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userIdEl.textContent = "Error: Could not connect to services.";
            }
        }

        /**
         * Handles user authentication state changes.
         */
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdEl.textContent = userId;
                    // User is signed in, start listening for their expense data.
                    listenForExpenses();
                } else {
                    // User is signed out, attempt to sign in.
                    await authenticateUser();
                }
            });
        }

        /**
         * Authenticates the user using the provided token or signs in anonymously.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdEl.textContent = "Authentication Failed.";
            }
        }

        /**
         * Sets up a real-time listener for the user's expenses in Firestore.
         */
        function listenForExpenses() {
            if (!db || !userId) return;

            // The collection path is constructed to be user-specific and secure.
            const expensesColPath = `/artifacts/${appId}/users/${userId}/grab_expenses`;
            const expensesCollection = collection(db, expensesColPath);
            const q = query(expensesCollection); // We fetch all and sort/filter client-side

            onSnapshot(q, (snapshot) => {
                loadingStateEl.style.display = 'none';
                allExpenses = [];
                snapshot.forEach(doc => {
                    allExpenses.push({ id: doc.id, ...doc.data() });
                });

                // Sort expenses by date, newest first
                allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (allExpenses.length === 0) {
                    noDataStateEl.style.display = 'table-row';
                } else {
                    noDataStateEl.style.display = 'none';
                }
                
                populateMonthFilter();
                updateUI();

            }, (error) => {
                console.error("Error fetching expenses: ", error);
                loadingStateEl.innerHTML = `<td colspan="3" class="text-center p-8 text-red-400">Error loading data.</td>`;
            });
        }
        
        /**
         * Populates the month filter dropdown based on available expense dates.
         */
        function populateMonthFilter() {
            const months = new Set();
            allExpenses.forEach(exp => {
                // Format date as "YYYY-MM" to represent a month uniquely
                const date = new Date(exp.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthKey);
            });

            // Clear existing options except "All Months"
            monthFilterEl.innerHTML = '<option value="all">All Months</option>';
            
            // Sort months chronologically and add them as options
            Array.from(months).sort().reverse().forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1);
                const optionText = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = optionText;
                monthFilterEl.appendChild(option);
            });
        }


        /**
         * Renders the expenses in the table and calculates totals based on the filter.
         */
        function updateUI() {
            const selectedMonth = monthFilterEl.value;
            
            const filteredExpenses = selectedMonth === 'all' 
                ? allExpenses 
                : allExpenses.filter(exp => {
                    const date = new Date(exp.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return monthKey === selectedMonth;
                });

            // Clear previous table rows
            tableBodyEl.innerHTML = '';
            
            if (filteredExpenses.length === 0 && allExpenses.length > 0) {
                 tableBodyEl.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">No expenses for the selected month.</td></tr>`;
            } else if (allExpenses.length === 0) {
                 loadingStateEl.style.display = 'none';
                 noDataStateEl.style.display = 'table-row';
            }

            let total = 0;
            filteredExpenses.forEach(exp => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                
                const formattedDate = new Date(exp.date).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                const formattedTotal = `â‚±${Number(exp.total).toFixed(2)}`;

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${exp.merchant || 'N/A'}</td>
                    <td class="px-6 py-4">${formattedDate}</td>
                    <td class="px-6 py-4 text-right font-mono">${formattedTotal}</td>
                `;
                tableBodyEl.appendChild(row);
                total += Number(exp.total);
            });

            monthTotalEl.textContent = `â‚±${total.toFixed(2)}`;
        }

        // --- Event Listeners ---
        monthFilterEl.addEventListener('change', updateUI);

        // --- App Initialization ---
        initializeFirebase();
        setupAuthListener();

    </script>
</body>
</html>
